!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("Cesium")):"function"==typeof define&&define.amd?define(["Cesium"],t):"object"==typeof exports?exports.MeasureTool=t(require("Cesium")):e.MeasureTool=t(e.Cesium)}(self,(e=>(()=>{"use strict";var t={89:t=>{t.exports=e}},i={};function o(e){var r=i[e];if(void 0!==r)return r.exports;var n=i[e]={exports:{}};return t[e](n,n.exports,o),n.exports}o.d=(e,t)=>{for(var i in t)o.o(t,i)&&!o.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var r={};return(()=>{o.d(r,{default:()=>P});var e=o(89);function t(e,t,i){void 0===i&&(i={});var o={type:"Feature"};return(0===i.id||i.id)&&(o.id=i.id),i.bbox&&(o.bbox=i.bbox),o.properties=t||{},o.geometry=e,o}function i(e){return!isNaN(e)&&null!==e&&!Array.isArray(e)}function n(e,t,i){if(null!==e)for(var o,r,s,a,l,c,h,u,d=0,p=0,y=e.type,m="FeatureCollection"===y,f="Feature"===y,v=m?e.features.length:1,g=0;g<v;g++){l=(u=!!(h=m?e.features[g].geometry:f?e.geometry:e)&&"GeometryCollection"===h.type)?h.geometries.length:1;for(var P=0;P<l;P++){var b=0,w=0;if(null!==(a=u?h.geometries[P]:h)){c=a.coordinates;var E=a.type;switch(d=!i||"Polygon"!==E&&"MultiPolygon"!==E?0:1,E){case null:break;case"Point":if(!1===t(c,p,g,b,w))return!1;p++,b++;break;case"LineString":case"MultiPoint":for(o=0;o<c.length;o++){if(!1===t(c[o],p,g,b,w))return!1;p++,"MultiPoint"===E&&b++}"LineString"===E&&b++;break;case"Polygon":case"MultiLineString":for(o=0;o<c.length;o++){for(r=0;r<c[o].length-d;r++){if(!1===t(c[o][r],p,g,b,w))return!1;p++}"MultiLineString"===E&&b++,"Polygon"===E&&w++}"Polygon"===E&&b++;break;case"MultiPolygon":for(o=0;o<c.length;o++){for(w=0,r=0;r<c[o].length;r++){for(s=0;s<c[o][r].length-d;s++){if(!1===t(c[o][r][s],p,g,b,w))return!1;p++}w++}b++}break;case"GeometryCollection":for(o=0;o<a.geometries.length;o++)if(!1===n(a.geometries[o],t,i))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}var s=6378137;function a(e){return function(e,t,i){var o=0;return function(e,t){var i,o,r,n,s,a,l,c,h,u,d=0,p="FeatureCollection"===e.type,y="Feature"===e.type,m=p?e.features.length:1;for(i=0;i<m;i++){for(a=p?e.features[i].geometry:y?e.geometry:e,c=p?e.features[i].properties:y?e.properties:{},h=p?e.features[i].bbox:y?e.bbox:void 0,u=p?e.features[i].id:y?e.id:void 0,s=(l=!!a&&"GeometryCollection"===a.type)?a.geometries.length:1,r=0;r<s;r++)if(null!==(n=l?a.geometries[r]:a))switch(n.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":if(!1===t(n,d,c,h,u))return!1;break;case"GeometryCollection":for(o=0;o<n.geometries.length;o++)if(!1===t(n.geometries[o],d,c,h,u))return!1;break;default:throw new Error("Unknown Geometry Type")}else if(!1===t(null,d,c,h,u))return!1;d++}}(e,(function(e,t,i,r,n){o=o+function(e){var t,i=0;switch(e.type){case"Polygon":return l(e.coordinates);case"MultiPolygon":for(t=0;t<e.coordinates.length;t++)i+=l(e.coordinates[t]);return i;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0}return 0}(e)})),o}(e)}function l(e){var t=0;if(e&&e.length>0){t+=Math.abs(c(e[0]));for(var i=1;i<e.length;i++)t-=Math.abs(c(e[i]))}return t}function c(e){var t,i,o,r,n,a,l=0,c=e.length;if(c>2){for(a=0;a<c;a++)a===c-2?(o=c-2,r=c-1,n=0):a===c-1?(o=c-1,r=0,n=1):(o=a,r=a+1,n=a+2),t=e[o],i=e[r],l+=(h(e[n][0])-h(t[0]))*Math.sin(h(i[1]));l=l*s*s/2}return l}function h(e){return e*Math.PI/180}const u=function(e,o){void 0===o&&(o={});var r=0,s=0,a=0;return n(e,(function(e){r+=e[0],s+=e[1],a++}),!0),function(e,o,r){if(void 0===r&&(r={}),!e)throw new Error("coordinates is required");if(!Array.isArray(e))throw new Error("coordinates must be an Array");if(e.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!i(e[0])||!i(e[1]))throw new Error("coordinates must contain numbers");return t({type:"Point",coordinates:e},o,r)}([r/a,s/a],o.properties)},d=(t,i)=>e.Cartesian3.distance(t,i),p=(t,i)=>e.Cartesian3.midpoint(t,i,new e.Cartesian3),y=(e,t)=>{let i="";const o=d(e,t);return i=o>1e3?(o/1e3).toFixed(2)+" km":o.toFixed(2)+" m",i},m=e=>{let t="";const{area:i,centroid:o}=f(e);return t=i<1e6?Math.abs(i).toFixed(4)+" ㎡":Math.abs(Number((i/1e6).toFixed(4)))+" k㎡",{text:t,centroid:o}},f=i=>{const o=i.map((t=>{const i=(t=>{const i=e.Cartographic.fromCartesian(t);return[e.Math.toDegrees(i.longitude),e.Math.toDegrees(i.latitude),i.height]})(t);return i})),r=function(e,i,o){void 0===o&&(o={});for(var r=0,n=e;r<n.length;r++){var s=n[r];if(s.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var a=0;a<s[s.length-1].length;a++)if(s[s.length-1][a]!==s[0][a])throw new Error("First and last Position are not equivalent.")}return t({type:"Polygon",coordinates:e},i,o)}([o]);var n;return{area:a(r),centroid:(n=u(r).geometry.coordinates,e.Cartesian3.fromDegrees(n[0],n[1],n[3]))}};var v,g=function(e,t){var i={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(i[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(i[o[r]]=e[o[r]])}return i};!function(e){e.Distance="distance",e.Area="area"}(v||(v={}));class P{constructor(t,i){this.measureType=v.Distance,this.tempPositions=[],this.viewer=t,this.options=Object.assign({showAllDistance:!0,showAllDistancePosition:"center",polylineStyle:{},polygonStyle:{},labelStyle:{}},i),this.dataSource=new e.CustomDataSource("Measure_dataSource"),this.viewer.dataSources.add(this.dataSource),this.viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(e.ScreenSpaceEventType.LEFT_DOUBLE_CLICK),this.handler=new e.ScreenSpaceEventHandler(this.viewer.scene.canvas)}activate(e){this.clearAll(),this.measureType=e,this.registerEvents(),this.viewer._element.style.cursor="crosshair"}deactivate(){this.unRegisterEvents(),this._mousePos=void 0,this.viewer._element.style.cursor="default"}clearAll(){var e;this.deactivate(),null===(e=this.dataSource)||void 0===e||e.entities.removeAll(),this.tempPositions=[]}registerEvents(){this.leftClickEvent(),this.rightClickEvent(),this.mouseMoveEvent()}unRegisterEvents(){var t,i,o,r;null===(t=this.handler)||void 0===t||t.removeInputAction(e.ScreenSpaceEventType.RIGHT_CLICK),null===(i=this.handler)||void 0===i||i.removeInputAction(e.ScreenSpaceEventType.LEFT_CLICK),null===(o=this.handler)||void 0===o||o.removeInputAction(e.ScreenSpaceEventType.MOUSE_MOVE),null===(r=this.handler)||void 0===r||r.removeInputAction(e.ScreenSpaceEventType.LEFT_DOUBLE_CLICK)}drawEnd(){var e,t;null===(t=null===(e=this.options)||void 0===e?void 0:e.onDrawEnd)||void 0===t||t.call(e,this.measureType,this.tempPositions),this.deactivate()}leftClickEvent(){var t;null===(t=this.handler)||void 0===t||t.setInputAction((e=>{let t=this.viewer.camera.getPickRay(e.position);if(!t)return;let i=this.viewer.scene.globe.pick(t,this.viewer.scene);i&&(this.tempPositions.push(i.clone()),this.drawStart2InitEntity(),this.refreshEntityLabel())}),e.ScreenSpaceEventType.LEFT_CLICK)}mouseMoveEvent(){var t;null===(t=this.handler)||void 0===t||t.setInputAction((e=>{if(0===this.tempPositions.length)return;let t=this.viewer.camera.getPickRay(e.endPosition);if(!t)return;let i=this.viewer.scene.globe.pick(t,this.viewer.scene);i&&(this._mousePos=i,this.refreshEntityLabel())}),e.ScreenSpaceEventType.MOUSE_MOVE)}rightClickEvent(){var t;null===(t=this.handler)||void 0===t||t.setInputAction((e=>{let t=this.viewer.camera.getPickRay(e.position);if(!t)return;let i=this.viewer.scene.globe.pick(t,this.viewer.scene);i&&(this.tempPositions.push(i.clone()),this.drawEnd(),this.refreshEntityLabel())}),e.ScreenSpaceEventType.RIGHT_CLICK)}drawStart2InitEntity(){if(1===this.tempPositions.length)switch(this.measureType){case v.Distance:this.addMeasureDistanceEntity();break;case v.Area:this.addMeasureAreaEntity()}}refreshEntityLabel(){switch(this.measureType){case v.Distance:this.addMeasureDistanceEntityLabel();break;case v.Area:this.addMeasureAreaEntityLabel()}}addMeasureDistanceEntity(){var t,i;const o=this.options.polylineStyle||{},{positions:r}=o,n=g(o,["positions"]),s=`${this.measureType}-id`;null===(t=this.dataSource)||void 0===t||t.entities.removeById(s),null===(i=this.dataSource)||void 0===i||i.entities.add({id:s,polyline:Object.assign({positions:new e.CallbackProperty((()=>{let e=Array.from(this.tempPositions);return this._mousePos&&e.push(this._mousePos),e}),!1),clampToGround:!0,width:3,material:new e.PolylineDashMaterialProperty({color:e.Color.YELLOW}),depthFailMaterial:new e.PolylineDashMaterialProperty({color:e.Color.YELLOW})},n)})}addMeasureAreaEntity(){var t,i;const o=this.options.polygonStyle||{},{hierarchy:r}=o,n=g(o,["hierarchy"]),s=this.options.polylineStyle||{},{positions:a}=s,l=g(s,["positions"]),c=`${this.measureType}-id`;null===(t=this.dataSource)||void 0===t||t.entities.removeById(c),null===(i=this.dataSource)||void 0===i||i.entities.add({id:c,polygon:Object.assign({hierarchy:new e.CallbackProperty((()=>{if(this.tempPositions.length>=2){let t=Array.from(this.tempPositions);return this._mousePos&&t.push(this._mousePos),new e.PolygonHierarchy(t)}}),!1),material:e.Color.RED.withAlpha(.4)},n),polyline:Object.assign({positions:new e.CallbackProperty((()=>{let e=Array.from(this.tempPositions);return this._mousePos&&e.push(this._mousePos),e.push(e[0]),e}),!1),clampToGround:!0,width:3,material:new e.PolylineDashMaterialProperty({color:e.Color.YELLOW}),depthFailMaterial:new e.PolylineDashMaterialProperty({color:e.Color.YELLOW})},l)})}addMeasureDistanceEntityLabel(){if(this._mousePos){const e=this.tempPositions.length;if(e>=1){let[t,i]=[this.tempPositions[e-1],this._mousePos];const o=p(t,i),r=y(t,i);this.addLabel(o,r,e)}}else{const e=this.tempPositions.length;if(e>=2){let[t,i]=[this.tempPositions[e-1],this.tempPositions[e-2]];const o=p(t,i),r=y(t,i);if(this.addLabel(o,r,e),this.options.showAllDistance&&e>=3){const e=(e=>{let t=0;for(let i=0;i<e.length-1;i++){const[o,r]=[e[i],e[i+1]];t+=d(o,r)}let i="";return i=t>1e3?(t/1e3).toFixed(2)+" km":t.toFixed(2)+" m","Total："+i})(this.tempPositions);if("center"===this.options.showAllDistancePosition){let t=[...this.tempPositions,this.tempPositions[0]];const{centroid:i}=f(t);this.addLabel(i,e,0)}else this.addLabel(t,e,0)}}}}addMeasureAreaEntityLabel(){if(this._mousePos){if(this.tempPositions.length>=2){let e=[...this.tempPositions,this._mousePos,this.tempPositions[0]];const{text:t,centroid:i}=m(e);this.addLabel(i,t)}}else if(this.tempPositions.length>=3){let e=[...this.tempPositions,this.tempPositions[0]];const{text:t,centroid:i}=m(e);this.addLabel(i,t)}}addLabel(t,i,o=1){var r,n;const s=this.options.labelStyle||{},{text:a}=s,l=g(s,["text"]),c=`${this.measureType}-id-label-${o}`;null===(r=this.dataSource)||void 0===r||r.entities.removeById(c),null===(n=this.dataSource)||void 0===n||n.entities.add({id:c,position:t,label:Object.assign({text:i,font:"14px sans-serif",style:e.LabelStyle.FILL_AND_OUTLINE,fillColor:e.Color.YELLOW,showBackground:!0,backgroundColor:new e.Color(.165,.165,.165,.8),backgroundPadding:new e.Cartesian2(6,6),pixelOffset:new e.Cartesian2(0,-25),disableDepthTestDistance:Number.POSITIVE_INFINITY},l)})}}})(),r.default})()));